<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>维基简介猜字游戏</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK SC", "PingFang SC", "Microsoft YaHei", sans-serif; margin: 20px; line-height: 1.6; }
  .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
  #masked{
    white-space: normal;
    font-family:
      "Noto Sans Mono CJK SC","Noto Sans CJK SC",
      "Microsoft YaHei UI","PingFang SC","SimSun",monospace;
    font-size: 20px;
    line-height: 1.25;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    min-height: 6em;
  }
  #masked-title{
    white-space: normal;
    font-family:
      "Noto Sans Mono CJK SC","Noto Sans CJK SC",
      "Microsoft YaHei UI","PingFang SC","SimSun",monospace;
    font-size: 20px;
    line-height: 1.25;
    padding: 0;
    border: 0;
    border-radius: 0;
    min-height: 0;
    margin: 6px 0 8px;
    background: transparent;
  }
  .cell{
    display:inline-block;
    width:1em;
    height:1.25em;
    line-height:1.25em;
    text-align:center;
    vertical-align:baseline;
    box-sizing:content-box;
    overflow:hidden;
    font-variant-numeric:tabular-nums;
    font-variant-east-asian:full-width;
  }
  .br{ display:block; height:0; }
  .stat { font-size: 14px; color: #555; }
  button { padding: 8px 12px; }
  input[type="text"] { padding: 8px; width: min(560px, 90vw); }
  .msg { color: #b00; font-size: 14px; }
  .ok { color: #070; }
  .muted { color: #888; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .mono-cjk {
    font-family: ui-monospace, Menlo, Consolas, "Noto Sans Mono CJK SC", monospace;
    font-size: 20px;
    line-height: 1.45;
    letter-spacing: 0.02em;
    white-space: pre-wrap;
    word-break: break-all;
    overflow-wrap: anywhere;
    text-transform: full-width;
    font-variant-east-asian: full-width;
    font-variant-numeric: tabular-nums;
  }
</style>
</head>
<body>
  <h1>魔女协会用维基简介猜字游戏</h1>
  <p class="muted">规则：只保留标点，其它位置显示“⬜”。每次可猜一个汉字；输入多个字视为“猜标题”。重复字符不计数。可用提示或放弃。</p>

  <div class="row">
    <button id="btn-new">开始新一局</button>
    <button id="btn-hint" disabled>提示</button>
    <button id="btn-giveup" disabled>放弃</button>
  </div>

  <div id="masked-title" class="mono-cjk" style="margin-bottom:6px"></div>
  <div id="masked" class="mono-cjk"></div>

  <div class="row">
    <input id="guess" type="text" placeholder="输入一个汉字或直接输入标题…" />
    <button id="btn-guess" disabled>提交</button>
  </div>

  <div class="row">
    <input id="seed" type="text" placeholder="输入房间码/种子，例：abc123" />
    <button id="btn-seed">用种子开局</button>
    <button id="btn-share" disabled>复制本局链接</button>
  </div>
  <div class="stat mono">
    <span id="round-seed" class="muted">房间码：—</span>
    <span id="share-url" class="muted" style="margin-left:12px"></span>
  </div>

  <div class="stat">
    <span id="stat-attempts">已猜次数：0</span>
    <span> | 错误：</span><span id="stat-wrongs"></span>
  </div>
  <div id="msg" class="msg"></div>
  <div id="answer" class="ok"></div>
  <div id="snippet" class="muted"></div>
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
<script>
(() => {
  const WORKER = "https://api.wikiguessing.space";
  const API_RANDOM = `${WORKER}/random`;
  const API_SUMMARY = (t) => `${WORKER}/summary?title=${encodeURIComponent(t)}`;
  const API_TOP = (y,m,d) => `${WORKER}/top?date=${y}/${m}/${d}`;

  const FIXED_DATES = [
    {y: 2024, m: 1, d: 1},
    {y: 2024, m: 7, d: 1},
    {y: 2025, m: 1, d: 1},
    {y: 2025, m: 5, d: 1}
  ];
  const TOPN_FIXED = 1000;
  const FIXED_POOL_KEY = "wiki_guess_fixed_pool_v1";
  const FALLBACK_POOL = [
    "中国","美国","日本","俄罗斯","北京","上海","台北","香港","广州","深圳",
    "周杰伦","成龙","张学友","刘德华","林俊杰",
    "篮球","足球","羽毛球","乒乓球","网球",
    "人工智能","机器学习","深度学习","神经网络",
    "第二次世界大战","冷战","罗马帝国","秦朝","汉朝","唐朝","宋朝","明朝","清朝",
    "计算机科学","互联网","操作系统","Linux","Python","C语言","Java","算法"
  ];

  let FIXED_POOL = null;

  async function fetchTopByDate(y, m, d) {
    const mm = String(m).padStart(2,"0");
    const dd = String(d).padStart(2,"0");
    const r = await fetch(API_TOP(y, mm, dd));
    if (!r.ok) throw new Error("top失败");
    const data = await r.json();
    const bad = new Set(["Main_Page","首页","维基百科:首页"]);
    return (data.items?.[0]?.articles || [])
      .map(a => a.article)
      .filter(t =>
        !bad.has(t) &&
        !/^特殊:|^Wikipedia:|^维基百科:|^File:|^文件:|^Category:|^分类:/.test(t) &&
        !/消歧义/.test(t)
      )
      .slice(0, TOPN_FIXED);
  }

  async function getFixedPool() {
    if (FIXED_POOL) return FIXED_POOL;
    try {
      const cached = JSON.parse(localStorage.getItem(FIXED_POOL_KEY) || "null");
      if (Array.isArray(cached) && cached.length) {
        FIXED_POOL = cached;
        return FIXED_POOL;
      }
    } catch {}
    const sets = [];
    for (const d of FIXED_DATES) {
      try { sets.push(await fetchTopByDate(d.y, d.m, d.d)); } catch {}
    }
    const merged = Array.from(new Set(sets.flat()));
    FIXED_POOL = merged.length ? merged : FALLBACK_POOL.slice();
    try { localStorage.setItem(FIXED_POOL_KEY, JSON.stringify(FIXED_POOL)); } catch {}
    return FIXED_POOL;
  }

  let title = "";
  let snippet = "";
  let masked = "";
  let guessed = new Set();
  let wrongs = [];
  let attempts = 0;
  let currentSeed = "";

  const elMasked = document.getElementById("masked");
  const elGuess  = document.getElementById("guess");
  const elBtnGuess = document.getElementById("btn-guess");
  const elBtnNew = document.getElementById("btn-new");
  const elBtnHint = document.getElementById("btn-hint");
  const elBtnGiveUp = document.getElementById("btn-giveup");
  const elAttempts = document.getElementById("stat-attempts");
  const elWrongs = document.getElementById("stat-wrongs");
  const elMsg = document.getElementById("msg");
  const elAns = document.getElementById("answer");
  const elSnip = document.getElementById("snippet");
  const elSeed = document.getElementById("seed");
  const elBtnSeed = document.getElementById("btn-seed");
  const elBtnShare = document.getElementById("btn-share");
  const elRoundSeed = document.getElementById("round-seed");
  const elShareUrl = document.getElementById("share-url");

  function isPunct(ch) { return /\p{P}/u.test(ch); }
  function isHan(ch) { return /\p{Script=Han}/u.test(ch); }
  const MASK = "\u2B1C"; // ⬜
  function maskSnippet(s) {
    return Array.from(s).map(ch => isPunct(ch) ? ch : (ch === "\n" ? "\n" : MASK)).join("");
  }
  function maskTitle(t){
    return Array.from(t).map(ch => isPunct(ch) ? ch : MASK).join("");
  }
  function reveal(sn, cur, ch) {
    const a = Array.from(sn), b = Array.from(cur);
    for (let i=0;i<a.length;i++) if (a[i] === ch) b[i] = ch;
    return b.join("");
  }
  function normalizeTitle(s) { return s.replace(/[\p{P}\s]/gu, "").toLowerCase(); }
  function setUIEnabled(enabled) {
    elBtnGuess.disabled = !enabled;
    elBtnHint.disabled = !enabled;
    elBtnGiveUp.disabled = !enabled;
    elGuess.disabled = !enabled;
  }
  function updateStats() {
    elAttempts.textContent = `已猜次数：${attempts}`;
    elWrongs.textContent = wrongs.length ? wrongs.join("") : "";
  }
  function showMasked(){
    renderCells(masked, elMasked);
  }
  function resetMsg() { elMsg.textContent = ""; }
  function say(t, ok=false) { elMsg.textContent = t; elMsg.className = ok ? "ok" : "msg"; }
  function fnv1a32(str) {
    let h = 0x811c9dc5 >>> 0;
    for (let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 0x01000193) >>> 0; }
    return h >>> 0;
  }
  function buildShareURL({seed}) {
    const base = location.origin + location.pathname.replace(/index\.html$/,'');
    return seed ? `${base}?seed=${encodeURIComponent(seed)}` : base;
  }
  function updateMaskedTitle(){
    const arr = Array.from(title).map(ch =>
      guessed.has(ch) ? ch : (isPunct(ch) ? ch : MASK)
    );
    renderCells(arr.join(""), document.getElementById("masked-title"));
  }

  function escapeHTML(s){
    return s.replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  }
  
  function renderCells(str, el){
    const html = Array.from(str).map(ch => {
      if (ch === "\n") return '<span class="br"></span>';
      return `<span class="cell">${escapeHTML(ch)}</span>`;
    }).join("");
    el.innerHTML = html;
  }

  async function fetchSummaryByTitle(t, minLen=120, maxLen=500) {
    const r = await fetch(API_SUMMARY(t));
    if (!r.ok) throw new Error("summary 请求失败");
    const data = await r.json();
    if (!data?.extract || data.type === "disambiguation") throw new Error("不合格");
  
    const disp = (data.titles && (data.titles.display || data.title)) || data.title;
    const clean = String(disp).replace(/<[^>]*>/g, "");  // 去 span
  
    let ex = String(data.extract).replace(/\u00A0/g, " ").replace(/\s+/g, " ").trim();
    if (ex.length < minLen) throw new Error("过短");
    return { title: clean.trim(), snippet: ex.slice(0, maxLen) };
  }

  async function fetchBySeed(seed, minLen=120, maxLen=500) {
    const pool = await getFixedPool();
    const base = fnv1a32(seed) % pool.length;
    for (let k=0; k<Math.min(64, pool.length); k++) {
      const t = pool[(base + k) % pool.length];
      try { return await fetchSummaryByTitle(t, minLen, maxLen); } catch {}
    }
    const fb = FALLBACK_POOL[fnv1a32("fb:"+seed) % FALLBACK_POOL.length];
    return await fetchSummaryByTitle(fb, minLen, maxLen);
  }

  async function fetchRandom(minLen=120, maxLen=500, tries=10) {
    for (let i=0;i<tries;i++){
      const r = await fetch(API_RANDOM);
      if (!r.ok) continue;
      const data = await r.json();
      if (!data?.extract || data.type === "disambiguation") continue;
      let ex = data.extract.replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
      if (ex.length >= minLen) return { title: data.title.trim(), snippet: ex.slice(0, maxLen) };
    }
    throw new Error("随机未命中");
  }

  function fullRevealed() {
    const a = Array.from(snippet), b = Array.from(masked);
    for (let i=0;i<a.length;i++) if (!isPunct(a[i]) && a[i] !== "\n" && b[i] === MASK) return false;
    return true;
  }

  async function startNew(options = {}) {
    setUIEnabled(false);
    elAns.textContent = "";
    elSnip.textContent = "";
    elMasked.textContent = "加载中…";
    elMsg.textContent = "";
    elGuess.value = "";
    guessed = new Set(); wrongs = []; attempts = 0; updateStats();
    elShareUrl.textContent = ""; elBtnShare.disabled = true;

    try {
      let got, seedUsed = "";

      if (options.seed) {
        got = await fetchBySeed(options.seed, 120, 500);
        seedUsed = options.seed;
      } else {
        const base = Math.random().toString(36).slice(2, 8);
        let used = base, ok = null;
        for (let i=0;i<32;i++){
          const s = i === 0 ? base : `${base}-${i}`;
          try { ok = await fetchBySeed(s, 120, 500); used = s; break; } catch {}
        }
        if (!ok) ok = await fetchRandom(120, 500, 12);
        got = ok; seedUsed = used;
      }

      title   = got.title;
      title = title.replace(/<[^>]*>/g, "");
      snippet = got.snippet;
      masked  = maskSnippet(snippet);
      showMasked();
      updateMaskedTitle();
      say("已开始。输入一个汉字进行猜测，或输入多个字直接猜标题。", true);
      setUIEnabled(true);
      elGuess.focus();

      currentSeed = seedUsed;
      elRoundSeed.textContent = "房间码：" + (currentSeed || "—");

      const share = buildShareURL({seed: currentSeed});
      elShareUrl.textContent = share;
      elBtnShare.disabled = false;
      elBtnShare.onclick = async () => {
        try { await navigator.clipboard.writeText(share); say("已复制本局链接", true); }
        catch { say("复制失败，请手动复制上方链接"); }
      };

    } catch(e) {
      say("拉取失败，稍后重试。");
      setUIEnabled(false);
    }
  }

  function onGuess() {
    resetMsg();
    const s = elGuess.value.trim();
    if (!s) return;

    if (Array.from(s).length > 1) {
      attempts += 1; updateStats();
      if (normalizeTitle(s) === normalizeTitle(title)) {
        say("命中标题。胜利。", true);
        elAns.textContent = `答案：${title}`;
        elSnip.textContent = `原文片段：${snippet}`;
        setUIEnabled(false);
      } else {
        say("标题不正确。");
      }
      elGuess.value = ""; return;
    }

    const ch = s;
    if (isPunct(ch) || ch === "\n") {
      say("这个字符无需猜。");
      elGuess.value = "";
      return;
    }
    if (guessed.has(ch)) { say("该字符已猜过，不计入次数。"); elGuess.value = ""; return; }

    guessed.add(ch);
    attempts += 1;

    if (Array.from(snippet).includes(ch)) {
      masked = reveal(snippet, masked, ch);
      showMasked(); say("命中。", true);
    } else {
      wrongs.push(ch);
      showMasked(); say("未命中。");
    }
    updateStats();
    updateMaskedTitle();
    elGuess.value = "";

    if (fullRevealed()) say("你已揭示全部内容。直接输入条目全名来获胜。", true);
  }

  function onHint() {
    const A = Array.from(snippet), B = Array.from(masked);
    for (let i=0;i<A.length;i++) {
      if (!isPunct(A[i]) && A[i] !== "\n" && B[i] === MASK) {
        const hintChar = A[i];
        if (!guessed.has(hintChar)) { 
          guessed.add(hintChar); attempts += 1;
          updateStats();
        }
        masked = reveal(snippet, masked, hintChar);
        showMasked();
        updateMaskedTitle();  
        say("已给提示：" + hintChar, true);
        if (fullRevealed()) say("你已揭示全部内容。直接输入条目全名来获胜。", true);
        return;
      }
    }
    say("无可用提示。");
  }

  function onGiveUp() {
    elAns.textContent = `放弃。本次答案：${title}`;
    elSnip.textContent = `原文片段：${snippet}`;
    setUIEnabled(false);
  }

  elBtnNew.addEventListener("click", () => startNew());
  elBtnGuess.addEventListener("click", onGuess);
  elBtnHint.addEventListener("click", onHint);
  elBtnGiveUp.addEventListener("click", onGiveUp);
  elGuess.addEventListener("keydown", (e) => { if (e.key === "Enter") onGuess(); });

  elBtnSeed.addEventListener("click", () => {
    const s = elSeed.value.trim();
    if (!s) { say("请输入房间码/种子后再开始"); return; }
    startNew({seed: s});
  });

  (function bootstrap() {
    const p = new URLSearchParams(location.search);
    const seed = p.get("seed") || "";
    if (seed) startNew({seed});
    else startNew();
  })();
})();
</script>
</body>
</html>







